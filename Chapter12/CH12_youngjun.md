## 동기화란

### 동기화의 의미

많은 프로세스들은 서로 데이터를 주고받으며 협력하며 실행될 수 있다.

이 때 아무렇게나 동시에 실행해서는 안되고 동기화가 필수

프로세스 동기화란 프로세스들 사이의 수행 시기를 맞추는 것을 의미

- 실행 순서 제어 : 프로세스를 올바른 순서대로 실행하기
- 상호 배제 : 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기

즉, 동기화에는 실행 순서 제어를 위한 동기화와, 상호 배제를 위한 동기화가 있다.

1. 실행 순서 제어를 위한 동기화
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a9ed5dee-5582-4912-b25d-a004cb37bcbe/Untitled.png)
    
    동시에 실행되는 프로세스를 올바른 순서대로 실행하는 것이 실행 순서 제어를 위한 동기화
    
2. 상호 배제를 위한 동기화
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/72e7ef0f-22c0-4444-a2ee-29f416c14d2c/Untitled.png)
    
    A와 B 둘다 잔액이라는 데이터를 동시에 사용하는데, A가 끝나기도 전에 B가 잔액을 읽어서 제대로 된 결과가 안나온다.
    
    이렇게 동시에 접근해서는 안 되는 자원에 동시에 접근하지 못하게 하는 것이 상호 배제를 위한 동기화
    

### 공유 자원과 임계 구역

공유자원은 여러 프로세스가 이용하는 공동의 자원으로 전역 변수, 파일, 입출력장치, 보조기억장치가 될 수 있다.

동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역을 임계 구역이라 한다.

두 개 이상의 프로세스가 임계 구역에 진입하고자 하면 둘 중 하나는 대기해야 한다.


여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우를 레이스 컨디션이라 한다.

레이스 컨디션은 여러 줄의 저급 언어로 변환된 고급 언어 한 줄을 실행하는 과정에서 문맥교환이 일어날 때 발생할 수 있다.


이때, 상호 배제를 위한 동기화는 이와 같은 일이 발생하지 않도록 두 개 이상의 프로세스가 임계 구역에 동시에 접근하지 못하도록 관리하는 것을 의미한다.

상호 배제를 위한 동기화를 위해서는 아래 세 가지 원칙을 지켜야한다.

1. 상호 배제 : 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다.
2. 진행 : 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다.
3. 유한 대기 : 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다.

## 동기화 기법

동기화를 위한 대표적인 도구로 뮤텍스 락, 세마포, 모니터가 있다.

### 뮤텍스 락

뮤텍스 락은 동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구, 다시 말해 상호 배제를 위한 동기화 도구이다.

임계 구역에 집입하는 프로세스는 뮤텍스 락을 이용해 임계 구역에 자물쇠를 걸어둘 수 있다.

뮤텍스 락의 단순한 형태는 하나의 전역 변수와 두 개의 함수로 구현할 수 있다.

- 자물쇠 역할 : 프로세스들이 공유하는 전역 변수 lock
- 임계 구역을 잠그는 역할 : acquire 함수
- 임계 구역의 잠금을 해제하는 역할 : release 함수

acquire 함수는 프로세스가 임계 구역에 진입하기 전에 호출하는 함수이다.

임계 구역이 잠겨 있다면 임계 구역이 열릴 때까지(lock이 false가 될 때까지) 반복적으로 확인하고, 열려 있다면 잠그는(lock을 true로 바꾸는) 함수이다. 

release 함수는 임계 구역에서의 작업이 끝나고 호출하는 함수이다. 현재 잠긴 임계 구역을 열어 주는 (lock을 false로 바꾸는) 함수라고 보면 된다.

### 세마포

뮤텍스 락과 비슷하지만, 조금 더 일반화된 방식의 동기화 도구이다.

뮤텍스 락은 하나의 공유 자우너에 접근하는 프로세스를 상정한 방식이지만, 세마포는 공유 자원이 여러 개 있는 상황에서도 적용이 가능한 동기화 도구이다.

세마포는 하나의 변수와 두 개의 함수로 단순하게 구현할 수 있다.

- 임계 구역에 진입할 수 있는 프로세스 개수(사용 가능한 공유 자우너의 개수)를 나타내는 전역 변수 S
- 임계 구역에 들어가도 좋은지, 기다려야 할지를 알려주는 wait 함수
- 임계 구역 앞에서 기다리는 프로세스에 ‘이제 가도 좋다’고 신호를 주는 signal 함수

wait 함수

```python
wait() {
	while ( S <= 0 )
	;
	S--;
}
```

signal 함수

```python
signal() {
	S++
}
```


사용할 수 있는 공유 자원이 없는 경우 프로세스는 무한히 반복하며 S를 확인해야 한다.

그래서 세마포는 wait 함수는 만일 사용할 수 있는 자원이 없을 경우 해당 프로세스 상태를 대기 상태로 만들고, 
그 프로세스의 PVB를 세마포를 위한 대기 큐에 집어넣고, 
다른 프로세스가 임계 구역에서의 작업이 끝나고 signal 함수를 호출하면 signal 함수는 대기 중인 프로세스를 대기 큐에서 제거하고 준비 큐로 옮긴다.

wait 함수

```python
wait() {
	S--;
	if ( S < 0 ) {
		add this process to Queue;
		sleep();
}
```

signal 함수

```python
signal() {
	S++
	if ( S <= 0) {
		remove a process p from Queue
		wakeup(p)
}
```

### 모니터

세마포는 매번 임계 구역에 앞뒤로 일일이 wait와 signal 함수를 명시하는 것은 번거롭다.

그래서 최근에 등장한 동기화 도구가 모니터 이다.

모니터는 세마포에 비해 편리한 도구로, 공유 자원과 공유 자원에 접근하기접근하기 위한 인터페이스(통로)를 묶어 관리한다.

프로세스는 반드시 인터페이스를 통해서만 공유 자원에 접근하도록 한다.

공유자원에 접근하고자 하는 프로세스를 큐에 삽입해서 모니터 안에 항상 하나의 프로세스만 들어오도록 하여 상호 배제를 위한 동기화를 제공한다.

실행 순서 제어를 위한 동기화도 제공한다.

특정 조건을 바탕으로 프로세스를 실행하고 일시 중단하기 위해 모니터는 조건 변수를 사용하는데, 조건 변수는 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별한 변수이다.

1. 특정 프로세스가 아직 실행될 조건이 되지 않았을 때 wait를 통해 실행을 중단한다.
2. 특정 프로세스가 실행될 조건이 충족되었을 때에는 signal을 통해 실행을 재개한다.
