# Chapter 12. 프로세스 동기화

## 12-1. 동기화란

### 동기화의 의미

프로세스 동기화란 프로세스들 사이의 수행 시기를 맞추는 것을 의미한다.

프로세스 동기화는 크게 아래 두 가지를 의미한다.

- 실행 순서 제어
    
    프로세스를 올바른 순서대로 실행하는 것을 의미한다.
    
    예를 들어 Book.txt 파일에 값을 저장하는 Writer 프로세스와
    
    Book.txt 파일의 값을 읽어오는 Reader 프로세스가 동시에 실행 중임을 가정해보자.
    
    Reader 프로세스는 Writer 프로세스가 Book.txt 파일에 값을 쓰고 나서 읽어와야 하므로
    
    실행 순서를 제어해주어야 한다.
    
- 상호 배제
    
    동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하는 방법이다.
    
    메모리에 저장된 값을 업데이트하는 프로세스가 있다고 가정하자.
    
    이 경우 메모리에 저장된 값을 레지스터에 복사한 후 연산을 진행하고 다시 메모리에 저장한다.
    
    예를 들어 이러한 프로세스가 2개가 있고, 두 프로세스가 동시에 실행된다면
    
    메모리에서 같은 값을 복사한 후 각자 연산을 진행하고 메모리의 값을 업데이트 한다.
    
    이렇게 진행될 경우 원하는 대로 값이 업데이트 되지 않는다.
    
    그렇기 때문에 같은 자원을 다루는 프로세스가 동시에 접근하지 못하도록 해야한다.
    

### 생산자와 소비자 문제

위에서 예를 든 예시와 동일한데, 생산자는 저장된 총합을 증가시키는 프로세스이고

소비자는 저장된 총합을 감소시키는 프로세스이다.

두 프로세스가 각각 100,000번씩 실행된다면 총합이 원래의 값으로 유지되는 것이 상식적이다.

하지만 상호 배제를 위한 동기화를 진행하지 않는다면 엉뚱한 결과가 나오게 된다.

### 공유 자원과 임계 구역

전역 변수, 파일, 입출력장치, 보조기억장치 등 여러 프로세스들이 접근할 수 있는 자원을 공유 자원이라고 한다.

동시에 실행하면 문제가 발생하는 지원에 접근하는 코드 영역을 임계 구역이라고 한다.

임계 구역은 두 개 이상의 프로세스가 동시에 실행되면 안 되는 영역이지만,

잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우를

레이스 컨디션(Race condition)이라고 한다.

레이스 컨디션이 발생하면 데이터의 일관성이 깨지는 문제가 발생한다.

그렇기 때문에 상호 배제를 위한 동기화를 통해 레이스 컨디션을 방지 해야한다.

상호 배제를 위한 동기화를 위해서는 아래 세 가지 원칙이 반드시 지켜져야만 한다.

- 상호 배제: 한 프로세스가 임계 구역에 진행했다면 다른 프로세스는 임계 구역에 들어올 수 없다.
- 진행: 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다.
- 유한 대기: 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다.

## 12-2. 동기화 기법

### 뮤텍스 락

뮤텍스 락은 동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구, 상호 배제를 위한 동기화 도구이다.

뮤텍스 락의 단순한 형태는 하나의 전역 변수와 두 개의 함수로 구현할 수 있다.

- 자물쇠 역할: 프로세스들이 공유하는 전역 변수 lock
- 임계 구역을 잠그는 역할: acquire 함수
- 임계 구역의 잠금을 해제하는 역할: release 함수

acquire 함수는 lock을 매번 확인하면서 기다리기 때문에 바쁜 대기(busy wait)라고 한다.

### 세마포

세마포(semaphore)는 뮤텍스 락과 비슷하지만 조금 더 일반화된 동기화 도구이다.

세마포는 뮤텍스 락과 비슷하게 하나의 변수와 두 개의 함수로 단순하게 구현할 수 있다.

- 임계 구역에 진입할 수 있는 프로세스의 개수를 나타내는 전역 변수 S
- 임계 구역에 들어가도 좋은지, 기다려야 할 지를 알려주는 wait 함수
- 임계 구역 앞에서 기다리는 프로세스에 ‘이제 가도 좋다’고 신호를 주는 signal 함수

세마포의 경우, wait 함수는 만일 사용할 수 있는 자원이 없을 경우 해당 프로세스 상태를 대기 상태로 만들고,

그 프로세스의 PCB를 세마포를 위한 대기 큐에 집어넣는다.

다른 프로세스가 임계 구역에서의 작업이 끝나고 signal 함수를 호출하면 signal 함수는

대기 중인 프로세스를 대기 큐에서 제거하고 프로세스 상태를 준비 상태로 변경한 뒤 준비 큐로 옮겨준다.

상호 배제는 위처럼 가능하고, 프로세스 순서를 제어하기 위해서는 먼저 실행하고 싶은 프로세스 뒤에 signal 함수를 붙이고,

다음에 실행할 프로세스 앞에 wait를 붙이면 된다.

 

### 모니터

모니터는 사용자가 사용하기에 훨씬 편리한 동기화 도구이다.

모니터는 공유 자원과 공유 자원에 접근하기 위한 인터페이스를 묶어 관리한다.

모니터를 통해 공유 자원에 접근하고자 하는 프로세스를 큐에 삽입하고,

큐에 삽입된 순서대로 하나씩 공유 자원을 이용하도록 한다.

특정 조건을 바탕으로 프로세스를 실행하고 일시 중단하기 위해 모니터는 조건 변수를 사용하는데,

조건 변수는 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별한 변수이다.
