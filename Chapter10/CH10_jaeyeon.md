# Chapter 10. 프로세스와 스레드

## 10-1. 프로세스 개요

### 프로세스 직접 확인하기

윈도우에서는 작업 관리자, 유닉스 체계 운영체제에서는 `ps` 명령어를 통해 확인할 수 있다.

프로세스는 사용자가 보이는 공간에서 실행되는 **포그라운드 프로세스**와 안 보이는 공간에서 실행되는 **백그라운드 프로세스**가 있다.

이러한 백그라운드 프로세스는 유닉스 체계 운영체제에서는 **데몬**, 윈도우 운영체제에서는 **서비스**라고 한다.

### 프로세스 제어 블록

CPU 자원은 한정돼있기 때문에 프로세스들은 번갈아가며 CPU 자원을 사용해야 한다.

운영체제는 **프로세스 제어 블록**(PCB: Process Control Block)을 이용하여 프로세스의 순서를 관리한다.

프로세스 제어 블록은 프로세스와 관련된 정보를 저장하는 자료 구조이다.

PCB는 프로세스 생성 시에 만들어지고 실행이 끝나면 폐기된다. PCB에 담기는 정보는 아래와 같다.

- 프로세스 ID : 특정 프로세스를 식별하기 위한 고유한 번호이다.
- 레지스터 값 : 프로세스가 이전 차례 때 사용했던 레지스터 값들을 저장한다.
- 프로세스 상태 : 현재 프로세스의 상태를 저장한다.
- CPU 스케줄링 정보 : 어떤 순서로 CPU를 할당받을지에 대한 정보를 기록한다.
- 메모리 관리 정보 : 프로세스가 저장된 주소와 베이스 레지스터, 한계 레지스터, 페이지 테이블 정보를 기록한다.
- 사용한 파일과 입출력장치 목록 : 어떤 입출력장치가 프로세스에 할당되었는지, 어떤 파일을 열었는지 저장한다.

### 문맥 교환

하나의 프로세스 수행을 재개하기 위해 기억해야 할 정보를 문맥(Context)라고 하며, 문맥은 해당 프로세스의 PCB에 저장된다.

기존 프로세스의 문맥을 PCB에 백업하고, 새로운 프로세스를 실행하기 위해 문맥을 PCB로부터 복구하여 새로운 프로세스를 실행하는 것을 문맥 교환(Context switching)이라고 한다.

### 프로세스의 메모리 영역

프로세스가 생성되면 커널 영역에 PCB가 생성되는데, 사용자 영역에는 아래와 같은 영역들이 배치된다.

- 코드 영역
    
    코드 영역(Code Segment)는 텍스트 영역(Text Segment)라고도 불린다.
    
    이 곳에는 기계어로 이루어진 명령어가 저장되어 있으며, 쓰기가 금지된 영역이다.
    
- 데이터 영역
    
    데이터 영역(Data Segment)는 프로그램이 실행되는 동안 유지할 데이터가 저장되는 공간이다.
    
    이러한 데이터의 예시로 전역 변수가 있다.
    
- 힙 영역
    
    힙 영역(Heap Segment)는 프로그램을 만드는 사용자가 직접 할당할 수 있는 공간이다.
    
    프로그래밍 과정에서 힙 영역에 메모리 공간을 할당했다면 해당 공간을 반환해야 하며, 반환하지 않고 계속 사용한다면 메모리 누수가 발생할 수 있으므로 주의해야 한다.
    
- 스택 영역
    
    스택 영역(Stack Segment)는 데이터를 일시적으로 저장하는 공간이며, 예시로 매개 변수, 지역 변수가 있다.
    

코드 영역과 데이터 영역은 크기가 변하지 않는 정적 할당 영역이고, 힙 영역과 스택 영역은 동적 할당 영역이다.

힙 영역은 메모리의 낮은 주소에서 높은 주소로 할당되고, 스택 영역은 높은 주소에서 낮은 주소로 할당된다.

## 10-2. 프로세스 상태와 계층 구조

### 프로세스 상태

- 생성 상태(new) : 프로세스가 막 메모리에 적재된 상태로, CPU의 할당을 기다린다.
- 준비 상태(ready) : 실행될 준비가 된 상태이고, 할당을 기다리는 상태이다.
- 실행 상태(running) : CPU를 할당받아 실행 중인 상태이다.
- 대기 상태(blocked) : 입출력장치의 작업을 기다리는 상태이다.
- 종료 상태(terminated) : 프로세스가 종료된 상태이고, PCB와 프로세스가 사용한 메모리를 정리한다.

### 프로세스 계층 구조

프로세스는 실행 도중 시스템 호출을 통해 다른 프로세스를 생성한다.

이 때 생성되는 프로세스를 **자식 프로세스**, 생성한 프로세스를 **부모 프로세스**라고 부른다.

부모 프로세스와 자식 프로세스는 다른 프로세스이므로 다른 PID를 가지며 자식 프로세스에는 PPID(Parent PID)가 기록되기도 한다.

자식 프로세스는 다시 부모 프로세스가 되기도 한다.

많은 운영체제는 최초의 프로세스가 자식 프로세스들을 생성하고, 생성된 자식 프로세스가 새로운 자식 프로세스들을 낳는 형식으로 여러 프로세스가 동시에 실행된다.

### 프로세스 생성 기법

부모 프로세스를 통해 생성된 자식 프로세스들은 **복제와 옷 갈아입기**를 통해 실행된다.

부모 프로세스는 **fork**를 통해 자신의 복사본을 자식 프로세스로 생성하고, **exec**를 통해 자신의 메모리 공간을 다른 프로그램으로 교체한다.

fork를 통해 복사본이 만들어진 뒤에 자식 프로세스는 exec 시스템 호출을 통해 새로운 프로그램으로 전환된다.

exec는 자신의 메모리 공간을 새로운 프로그램으로 덮어쓰는 시스템 호출이다.
