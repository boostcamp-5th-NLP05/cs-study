# Chapter 13. 교착 상태

## 13-1. 교착 상태란

### 식사하는 철학자 문제

교착 상태를 설명할 수 있는 고전적인 문제 상황이다.

5명의 철학자가 원탁에 앉아있고 음식 5개와 포크 5개가 놓여있다.

계속 생각을 하다가 왼쪽 포크가 사용 가능하면 집어들고,

마찬가지로 생각을 하다가 오른쪽 포크가 사용 가능하면 집어든다.

포크 2개를 집으면 정해진 시간 동안 식사를 한 후 차례대로 오른쪽 포크, 왼쪽 포크를 내려놓는다.

만약 포크가 사용 중이라면 기다려야 한다. 위 과정을 반복한다.

한두명의 철학자만 식사를 한다면 문제가 발생하지 않지만 여러명이 한 번에 식사를 한다면

포크를 든 채로 기다리거나, 계속 포크만 기다리는 철학자가 발생할 수 있다.

이처럼 일어나지 않을 사건을 기다리며 진행이 멈춰 버리는 현상을 교착 상태라고 한다.

식사하는 철학자 문제에서 철학자는 프로세스 혹은 스레드,  포크는 자원, 생각하는 행위는

기다리는 것에 빗대어서 생각할 수 있다.

두 프로세스가 서로의 자원을 기다리는 것이 교착 상태의 대표적인 예시이다.

### 자원 할당 그래프

교착 상태는 자원 할당 그래프를 통해 단순하게 표현할 수 있다.

1. 프로세스는 원으로, 자원의 종류는 사각형으로 표현한다.
2. 사용할 수 있는 자원의 개수는 자원 사각형 내에 점으로 표현한다.
3. 프로세스가 어떤 자원을 할당받아 사용 중이라면 자원에서 프로세스를 향해 화살표를 표시한다.
4. 프로세스가 어떤 자원을 기다리고 있다면 프로세스에서 자원으로 화살표를 표시한다.

### 교착 상태 발생 조건

- 상호 배제
    
    교착 상태의 근본적인 원인은 해당 자원을 한 번에 하나의 프로세스만 이용 가능했기 때문이다.
    
    철학자 문제에서도 포크를 여러 명이 사용할 수 있었다면 교착 상태가 일어나지 않을 것이다.
    
- 점유와 대기
    
    어떠한 자원을 할당받은 상태에서 다른 자원을 할당받기를 기다린다면 교착 상태가 발생할 수 있다.
    
- 비선점
    
    비선점 자원은 그 자원을 이용하는 프로세스의 작업이 끝나야만 비로소 이용할 수 있다.
    
- 원형 대기
    
    자원 할당 그래프가 원의 형태로 그려지면 교착 상태가 발생할 수 있다.
    

위 4가지 조건들이 모두 갖춰졌을 때 교착 상태가 발생할 수도 있다.

그 말은, 4가지 조건 중 하나만 해결해준다면 교착 상태가 발생하지 않는다는 뜻이다.

## 교착 상태 해결 방법

### 교착 상태 예방

- 자원의 상호 배제를 없애기
    
    모든 자원을 공유 가능하게 만드는 것은 현실적으로 어렵기 때문에 좋은 방법이 아니다.
    
- 점유와 대기 없애기
    
    한 자원을 잡은 채로 다른 자원을 기다리는 일은 없겠지만 단점도 존재한다.
    
    우선, 자원의 활용률이 낮아질 우려가 있따. 점유와 대기를 금지하면 한 프로세스에
    
    필요한 자원을 몰아주고, 그 다음에 다른 프로세스에 필요한 자원들을 몰아줘야 한다.
    
    그렇기 때문에 당장 자원이 필요해도 기다릴 수 밖에 없는 프로세스,
    
    사용되지 않으면서 오랫동안 할당되는 자원을 다수 양산하며 자원의 활용률이 낮아진다.
    
    또한 자원을 많이 사용하는 프로세스의 경우 동시에 필요한 자원을 모두 사용할 수 있는
    
    타이밍을 잡기가 힘들어지기 때문에 기아 현상을 야기할 우려가 있다.
    
- 비선점 조건 없애기
    
    비선점 조건을 없애면 자원을 이용 중인 프로세스로부터 해당 자원을 빼앗아 올 수 있다.
    
    CPU와 같은 자원에는 효과적인 방법이지만, 프린터와 같은 자원에는 효과적이지 않다.
    
    그렇기 때문에, 비선점 조건을 없애는 것은 범용성이 떨어지는 방법이다.
    
- 원형 대기 조건 없애기
    
    모든 자원에 번호를 붙이고, 오름차순으로 자원을 할당하면 원형 대기가 발생하지 않는다.
    
    꽤나 현실적이고 실용적이지만, 컴퓨터 시스템 내에 존재하는 모든 자원에 번호를 붙이는 일은
    
    쉽지 않을 뿐더러, 어떤 식으로 번호를 붙이냐에 따라서 특정 자원의 활용률이 떨어질 수 있다.
    

위처럼 교착 상태의 발생 조건을 원천적으로 제거하는 것은 교착 상태가 발생하지 않음을 보장하지만

그에 따른 여러 부작용들이 발생할 수 있다.

### 교착 상태 회피

교착 상태가 발생하지 않을 정도로만 조심히 자원을 할당하는 방식이다.

교착 상태 회피 방식에서는 교착 상태를 한정된 자원의 무분별한 할당으로 인해 발생하는 문제로 간주한다.

자원의 양이 충분하거나, 프로세스가 적당한 자원을 요구하면 교착 상태는 일어나지 않을 것이다.

그렇기 때문에, 프로세스들에 배분할 수 있는 자원의 양을 고려하여 교착 상태가

발생하지 않을 정도의 양만큼만 자원을 배분하는 방법이 교착 상태 회피이다.

**안전 상태** : 교착 상태가 발생하지 않고 모든 프로세스가 정상적으로 자원을 할당 받고 종료될 수 있는 상태

**불안전 상태** : 교착 상태가 발생할 수도 있는 상황

**안전 순서열**은 교착 상태 없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서를 의미한다.

안전 순서열대로 자원을 배분하면 각 프로세스들이 모두 자원을 할당 받고 교착 상태 없이 올바르게 작업을 마칠 수 있다.

### 교착 상태 검출 후 회복

교착 상태 발생을 인정하고 사후에 조치하는 방식이다.

검출 후 회복 방식에서 운영체제는 프로세스들이 자원을 요구할 때마다 그때그때 모두 할당하며,

교착 상태 발생 여부를 주기적으로 검사한다. 그리고 교착 상태가 검출되면 회복 과정을 진행한다.

- 선점을 통한 회복
    
    교착 상태가 해결될 때까지 한 프로세스씩 자원을 몰아주는 방식이다.
    
- 프로세스 강제 종료를 통한 회복
    
    운영체제는 교착 상태에 놓인 프로세스를 모두 강제 종료할 수도 있고, 교착 상태가 없어질 때까지
    
    한 프로세스씩 강제 종료할 수도 있다.
    

번외로, 교착 상태를 아예 무시하는 **타조 알고리즘**도 있다.

문제를 예방하고 회피하고 회복하는 비용이 너무 많이 들면 그냥 덮고 가는 것이 효율적일 때도 있다.
