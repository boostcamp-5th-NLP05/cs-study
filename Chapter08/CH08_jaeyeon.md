# Chapter 08. 입출력장치

## 08-1. 장치 컨트롤러와 장치 드라이버

### 장치 컨트롤러

입출력 장치는 종류가 매우 많고, CPU와 메모리에 비해서 데이터 전송률이 낮기 때문에 다루기가 까다롭다는 특징이 있다. 그렇기 때문에 입출력장치는 컴퓨터에 직접 연결되지 않고 장치 컨트롤러(입출력 제어기, 입출력 모듈)라는 하드웨어를 통해 연결된다.

장치 컨트롤러는 크게 아래와 같은 역할을 한다.

- CPU와 입출력장치 간의 통신 중개
- 오류 검출
- 데이터 버퍼링

입출력장치의 종류가 많기 때문에 장치 컨트롤러를 통해서 규격화하였다. 

또한 데이터를 바로바로 쓰는 것이 아닌, 버퍼를 두어 데이터 전송률의 차이를 극복하는 전략을 사용한다.

장치 컨트롤러의 내부 구조는 아래와 같다.

- 데이터 레지스터 : CPU와 입출력장치 사이에 주고 받을 데이터가 담기는 레지스터.
- 상태 레지스터 : 입출력장치가 입출력 작업을 할 준비가 되었는지, 완료되었는지, 오류는 없는지 등의 상태 정보가 담기는 레지스터
- 제어 레지스터 : 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장하는 레지스터.

## 장치 드라이버

장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를  주고받을 수 있게 하는 프로그램이다.

입출력장치를 연결하기 위한 소프트웨어적인 통로로 볼 수 있다.

## 08-2. 다양한 입출력 방법

### 프로그램 입출력

기본적으로 프로그램 속 명령어로 입출력장치를 제어하는 방법이다.

메모리에 저장된 정보를 하드 디스크에 백업하는 과정은 아래와 같이 흘러간다.

1. CPU가 하드 디스크 컨트롤러의 제어 레지스터에 쓰기 명령을 보낸다.
2. 하드 디스크 컨트롤러는 하드 디스크의 상태를 확인하여 상태 레지스터에 표시한다.
3. CPU는 상태 레지스터를 주기적으로 읽어보며 하드 디스크의 준비 여부를 확인하고, 쓰기가 끝나면 작업을 종료한다.

CPU가 입출력장치의 주소를 어떻게 알고 쓰는건지, 메모리에 어떻게 저장돼있는지 알아보자.

- 메모리 맵 입출력(memory-mapped I/O)
    
    메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법이다.
    
    CPU는 장치 컨트롤러의 레지스터를 다룰 때 메모리 주소를 다루듯이 사용하면 되기 때문에 특별한 명령어가 필요 없다.
    
- 고립형 입출력(isolated I/O)
    
    메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법이다.
    
    제어 버스에 ‘입출력장치 읽기/쓰기’선을 따로 두는 식의 방법으로 독립된 주소 공간을 가지게끔 한다.
    
    그렇기 때문에 CPU는 기존 메모리에 접근하는 방법과 다르게 입출력장치에 접근해야하므로 별도의 명령어가 필요하다.
    

| 메모리 맵 입출력 | 고립형 입출력 |
| --- | --- |
| 메모리와 입출력장치는 같은 주소 공간 사용 | 메모리와 입출력장치는 분리된 주소 공간 사용 |
| 메모리 주소 공간이 축소됨 | 메모리 주소 공간이 축소되지 않음 |
| 메모리와 입출력장치에 같은 명령어 사용 가능 | 입출력 전용 명령어 사용 |

### 인터럽트 기반 입출력

장치 컨트롤러가 발생시키는 인터럽트를 기반으로 입출력을 진행하는 방식이다.

CPU가 장치 컨트롤러에 입출력 명령을 내린 후에 장치 컨트롤러가 입출력 작업을 수행하고, 작업이 끝나면 CPU에 인터럽트 요청을 보내는 식으로 작동한다.

컴퓨터에는 다양한 입출력장치들이 있기 때문에, CPU는 이러한 입출력장치들로부터의 인터럽트를 처리할 순서도 고려해야한다. 

그렇기 때문에 인터럽트 간에 우선순위를 고려해서 우선순위가 높은 인터럽트 순으로 여러 인터럽트를 처리한다.

이러한 방법을 사용하기 위해 프로그래머블 인터럽트 컨트롤러(PIC)라는 하드웨어를 사용한다.

PIC의 다중 인터럽트 처리 과정은 아래와 같다.

1. PIC가 장치 컨트롤러에서 인터럽트 요청 신호들을 받아들인다.
2. PIC는 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보낸다.
3. CPU는 PIC에 인터럽트 확인 신호를 보낸다.
4. PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보낸다.
5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 인터럽트 서비스 루틴을 실행한다.

보통 더 많은 장치들을 관리하기 위해 PIC를 두 개 이상 계층적으로 구성한다.

### DMA 입출력

앞서 보았던 입출력 방식들의 경우, 입출력장치의 데이터를 메모리에 적재하려고 할 때 장치 컨트롤러에서 데이터를 가져와서 레지스터에 적재한 후, 레지스터에 적재한 데이터를 메모리에 저장하는 방식으로 작동했다.

또한 메모리에 있는 데이터를 입출력장치로 내보낼 때는 위 과정의 역순으로 수행한다.

이러한 방식은 모든 데이터가 CPU를 2번씩 접근하기 때문에 연산 측면에서 비효율적이다.

그렇기 때문에 입출력 장치와 메모리가 직접적으로 상호작용할 수 있는 DMA(Direct Memory Access)가 등장하였다.

DMA 입출력을 위해서는 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어가 필요하다.

- DMA 입출력 과정
    1. CPU는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산, 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령한다.
    2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다. 이때 DMA 컨트롤러는 필요한 경우 메모리에 직접 접근하여 정보를 읽거나 쓴다.
    3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알린다.

위 과정을 보면 데이터는 CPU를 거치지 않고, 작업의 시작과 끝에만 CPU가 관여하게 된다.

하지만 공용 자원인 시스템 버스를 CPU, DMA 컨트롤러가 모두 쓰기 때문에 동시에 작업할 수 없다는 단점이 있다.

- 입출력 버스
    
    시스템 버스를 공통적으로 사용한다는 점을 해결하기 위해 입출력 버스가 등장하였다.
    
    장치 컨트롤러들이 시스템 버스가 아닌 입출력 버스로 DMA 컨트롤러에 연결된다면 DMA 컨트롤러와 장치 컨트롤러가 서로 데이터를 전송할 때는 시스템 버스를 이용할 필요가 없어진다.
    
    현재 대부분의 컴퓨터는 입출력 버스가 있으며 PCI(Peripheral Component Interconnect) 버스, PCI Express 버스 등이 있다.
