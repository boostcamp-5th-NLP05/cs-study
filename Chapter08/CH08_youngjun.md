## 08-1 장치 컨트롤러와 장치 드라이버

입출력장치가 CPU, 메모리보다 다루기가 더 까다로운 이유

1. 입출력장치는 종류가 너무 많다.
    
    장치가 다양하면, 장치마다 속도, 데이터, 전송  형식 등도 다양하다. 따라서 다양한 입출력장치와 정보를 주고받는 방식을 규격화하기가 어렵다.
    
2. 입출력장치의 데이터 전송률은 낮다.
    
    전송률이란 데이터를 얼마나 빨리 교환할 수 있는지를 나타내는 지표로 키모드나 마우스와 같이 상대적으로 전송률이 낮은 장치는 같은 시간 동안 데이터를 조금씩만 주고받을 수 있다. 전송률의 차이는 CPU와 메모리, 입출력장치 간의 통신을 어렵게 한다.
    

### 장치 컨트롤러

위와 같은 이유로 입출력 장치는 컴퓨터에 직접 연결되지 않고, 장치 컨트롤러라는 하드웨어를 통해 연결된다. 장치 컨트롤러는 입출력 제어기, 입출력 모듈 등으로 불리기도 한다.

모든 입출력장치는 각자의 장치 컨트롤러를 통해 컴퓨터 내부와 정보를 주고받고, 장치 컨트롤러는 하나 이상의 입출력장치와 연결되어 있다.

장치 컨트롤러는 대표적으로 아래 세 가지 역할을 통해 언급한 문제를 해결한다.

- CPU와 입출력장치 간의 통신 중개
- 오류 검출
- 데이터 버퍼링

종류가 많아 정보 규격화가 어려웠던 문제는 장치 컨트롤러가 일종의 번역가 역할을 함으로써 해결할 수 있다. 

데이터 버퍼링은 전송률이 높은 장치와 낮은 장치 사이에 주고받는 데이터를 버퍼라는 임시 저장 공간에 저장하여 전송률을 비슷하게 맞추는 방법

쉽게 말하면 버퍼링은 ‘버퍼에 데이터를 조금씩 모았다가 한꺼번에 내보내거나, 데이터를 한 번에 많이 받아 조금씩 내보내는 방법’

### 장치 컨트롤러의 간략화된 내부 구조

- 데이터 레지스터
    
    CPU와 입출력장치 사이에 주고받을 데이터가 담기는 레지스터. 데이터 레지스터가 버퍼 역할을 한다.
    
- 상태 레지스터
    
    입출력장치가 입출력 작업을 할 준비가 되었는지 , 입출력 작업이 완료되었는지, 입출력장치에 오류는 없는지 등의 상태 정보가 저장된다.
    
- 제어 레지스터
    
    입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장
    

### 장치 드라이버

새로운 장치를 컴퓨터에 연결하려면 장치 드라이버를 설치해야 한다.

장치 드라이버란 장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램

## 다양한 입출력 방법

장치 컨트롤러가 CPU와 정보를 주고받는 방법에는 **프로그램 입출력**, **인터럽트 기반 입출력**, **DMA 입출력**으로 크게 세 가지 방법이 있다.

### 프로그램 입출력

프로그램 입출력은 기본적으로 프로그램 속 명령어로 입출력장치를 제어하는 방법

CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하여 입출력 작업을 수행한다.

- 메모리에 저장된 정보를 하드 디스크에 백업하는 과정
    1. 메모리에 저장된 정보를 하드 디스크에 백업한다는 말은 하드 디스크에 새로운 정보를 쓴다는 말과 같다. 우선 CPU는 하드 디스크 컨트롤러의 제어 레지스터에 쓰기 명령을 보낸다.
    2. 하드 디스크 컨트롤러는 하드 디스크 상태를 확인한다. 상태 레지스터에 상태를 표시한다.
    3. CPU는 상태 레지스터를 주기적으로 읽어 하드 디스크의 준비 여부를 확인한다. 준비가 됐음을 CPU가 알게 되면 백업할 메모리를 데이터 레지스터에 쓴다. 백업 작업이 끝나지 않았다면 1번부터 반복하고, 끝났다면 작업을 종료한다.

이 떄 CPU는 장치 컨트롤러 속 레지스터들을 모두 알고 있기 어렵다. 컨트롤러에 접근하는 명령어가 표현되고 메모리에 저장되어 있는 방식에는 크게 메모리 맵 입출력과 고립형 입출력 방식이 있다.

### 메모리 맵 입출력

메모리 맵 입출력은 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법

1024개의 주소를 표현할 수 있는 컴퓨터가 있을 때, 전부 메모리 주소를 표현하는 데 사용하지 않고 일부는 장치 컨트롤러의 레지스터를 표현하기 위해 사용하는 것

메모리 맵 입출력 방식에서 CPU는 메모리의 주소들이나 장치 커늩롤러의 레지스터들이나 모두 똑같이 메모리 주소 대하듯 하면 된다는 점이 중요하다. 

### 고립형 입출력

고립형 입출력은 메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법.

아래 그림처럼 제어 버스에 ‘메모리 읽기/쓰기’ 선 이외에 ‘입출력장치 읽기/쓰기’ 선이 따로 있다면 메모리에도 주소 공간을 활용하고 입출력 장치에도 주소 공간을 활용할 수 있다.

고립형 입출력 방식에서 CPU는 입출력 장치에 접근하기 위해 메모리에 접근하는 명령어와는 다른 입출력 명령어를 사용한다.

| 메모리 맵 입출력 | 고립형 입출력 |
| --- | --- |
| 메모리와 입출력장치는 같은 주소 공간 사용 | 메모리와 입출력 장치는 분리된 주소 공간 사용 |
| 메모리 주소 공간이 축소됨 | 메모리 주소 공간이 축소되지 않음 |
| 메모리와 입출력장치에 같은 명령어 사용 가능 | 입출력 전용 명령어 사용 |

### 인터럽트 기반 입출력

CPU가 입출력장치에 처리할 내용을 명령하면 입출력장치가 명령어를 수행하는 동안 CPU는 다른 일을 할 수 있다.

입출력장치가 VPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 멈추고 해당 인터럽트를 처리하는 프로그램인 인터럽트 서비스 루틴을 실행한 뒤 다시 하던 일로 되돌아온다.

장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 백업하고 인터럽트 서비스 루틴을 실행한다.

이렇게 인터럽트를 기반으로 하는 입출력을 인터럽트 기반 입출력이라 한다.

- 여러 입출력장치에서 인터럽트가 동시에 발생한 경우 인터럽트들을 처리하는 방법
    
    발생한 순서대로 인터럽트를 처리하는 방법이 있다.
    
    그러나 모든 인터럽트 중에서도 더 빨리 처리해야 하는 인터럽트가 있기 때문에 순서대로 처리하면 안되고, CPU는 인터럽트 간에 우선순위를 고려해서 높은 인터럽트 순으로 여러 인터럽트를 처리해야 한다.
    
    우선순위를 반영하여 다중 인터럽트를 처리하는 방법에는 여러 가지가 있지만, 프로그래머블 인터럽트 컨트롤러(PIC)라는 하드웨어를 사용해서, 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야 할 하드웨어 인터럽트가 무엇인지 알려준다.
    
    - PIC의 다중 인터럽트 처리 과정
        1. PIC가 장치 컨트롤러에서 인터럽트 요청 신호를 받아들인다.
        2. PIC는 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보낸다.
        3. CPU는 PIC에 인터럽트 확인 신호를 보낸다.
        4. PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보낸다.
        5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 인터럽트 서비스 루틴을 실행한다.
    

### DMA 입출력

프로그램 기반 입출력과 인터럽트 기반 입출력에 공통점이 있다면 입출력장치와 메모리 간의 데이터 이동은 CPU가 주도하고, 이동하는 데이터도 반드시 CPU를 거친다는 점이다.

입출력장치와 메모리 사이에 전송되는 모든 데이터가 반드시 CPU를 거친다면 CPU의 부담이 커진다.

그래서 입출력장치와 메모리가 CPU를 거치지 않고 상호작용할 수 있는 입출력 방식인 DMA가 등장했다.(Direct Memory Access)

DMA 입출력을 하기 위해서는 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어가 필요하다.


### DMA 입출력 과정

1. CPU는 DMA컨트롤러에 입출력장치의 주소, 수행할 연산, 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령한다.
2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다. 이때 DMA컨트롤러는 메모리에 직접 접근하여 정보를 읽거나 쓴다.
3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알린다.

CPU는 DMA 컨트롤러에 입출력 작업 명령만 내리고, 인터럽트만 받으면 되기 때문에 작업 부담을 훨씬 줄일 수 있다.

이 때 시스템 버스는 동시 사용이 불가능하기 때문에 DMA 컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템 버스를 이요하거나, CPU가 일시적으로 시스템 버스를 이용하지 않도록 허락을 구하고 시스템 버스를 집중적으로 이용한다.(사이클 스틸링)

### 입출력 버스

CPU, 메모리, DMA 컨트롤러, 장치 컨트롤러가 모두 같은 버스를 공유하는 구성에는 DMA를 위해 한 번 메모리에 접근할 때마다 시스템 버스를 두 번 사용하게 되는 부작용이 있다.

이러한 문제는 DMA 컨트롤러와 장치 컨트롤러들을 입출력 버스라는 별도의 버스에 연결하여 해결할 수 있다. 

장치 컨트롤러들이 시스템 버스가 아닌 입출력 버스로 DMA 컨트롤러에 연결된다면 DMA 컨트롤러와 장치 컨트롤러가 서로 데이터를 전송할 때는 시스템 버스를 이요할 필요가 없어서, 시스템 버스의 사용 빈도를 줄일 수 있다.


현대 대부분 컴퓨터에는 입출력 버스가 있다.
